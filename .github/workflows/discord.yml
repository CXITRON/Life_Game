name: Discord Notification (Enhanced)

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Send enhanced Discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          #--- 변수 추출
          repo="$GITHUB_REPOSITORY"
          branch=${GITHUB_REF#refs/heads/}
          author=$(jq -r .head_commit.author.name < "$GITHUB_EVENT_PATH")
          msg=$(jq -r .head_commit.message     < "$GITHUB_EVENT_PATH")
          url=$(jq -r .head_commit.url         < "$GITHUB_EVENT_PATH")

          #--- jq 보간으로 JSON 생성
          payload=$(jq -n \
            --arg r "$repo" \
            --arg b "$branch" \
            --arg a "$author" \
            --arg m "$msg" \
            --arg u "$url" \
            '{content:"**🚀 [\($r):\($b)]** \($a) pushed a new commit\n> \($m)\n🔗 \($u)"}'
          )

          #--- 전송
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$payload" \
               "$DISCORD_WEBHOOK_URL"
