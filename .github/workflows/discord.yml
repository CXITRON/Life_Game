name: Discord Notification (Enhanced)

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1) ë¨¼ì € ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2) jq ì„¤ì¹˜
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # 3) Discord ë©”ì‹œì§€ ì „ì†¡
      - name: Send enhanced Discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          # payloadì—ì„œ ì»¤ë°‹ ë©”ì‹œì§€Â·ì‘ì„±ìÂ·URL ì¶”ì¶œ
          COMMIT_MSG=$(jq -r .head_commit.message < "$GITHUB_EVENT_PATH")
          COMMIT_URL=$(jq -r .head_commit.url     < "$GITHUB_EVENT_PATH")
          COMMIT_AUTHOR=$(jq -r .head_commit.author.name < "$GITHUB_EVENT_PATH")
          BRANCH=${GITHUB_REF#refs/heads/}

          # JSON í˜ì´ë¡œë“œ ìƒì„±
          PAYLOAD=$(jq -n \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg branch "$BRANCH" \
            --arg author "$COMMIT_AUTHOR" \
            --arg msg "$COMMIT_MSG" \
            --arg url "$COMMIT_URL" \
            '{content: "**ğŸš€ [$repo:$branch]** $author pushed a new commit\n> $msg\nğŸ”— $url"}'
          )

          # Discordë¡œ ì „ì†¡
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
